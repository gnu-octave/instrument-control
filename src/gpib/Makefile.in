OCT := ../gpib.oct
OBJ := gpib.o gpib_timeout.o gpib_write.o gpib_close.o gpib_read.o __gpib_spoll__.o __gpib_trigger__.o __gpib_clrdevice__.o gpib_class.o __gpib_pkg_lock__.o

MKOCTFILE  ?= mkoctfile
GREP ?= @GREP@

CFLAGS      = @DEFS@
LFLAGS      = @GPIBLIBS@

CC_SOURCES  := $(wildcard *.cc)
CC_TST_SOURCES := $(shell $(GREP) --files-with-matches '^%!' $(CC_SOURCES))
TST_SOURCES := $(patsubst %.cc,../../inst/test/%.cc-tst,$(CC_TST_SOURCES))

all: $(OCT) $(TST_SOURCES)

%.o: %.cc
	$(MKOCTFILE) $(CFLAGS) -c $^

%.oct: $(OBJ)
	$(MKOCTFILE) $^ $(LFLAGS) -o $@

../../inst/test:
	@mkdir -p "$@"

$(TST_SOURCES): ../../inst/test/%.cc-tst: %.cc | ../../inst/test
	@echo "Extracting tests from $< ..."
	@$(RM) -f "$@" "$@-t"
	@(      echo "## Generated from $<"; \
	        $(GREP) '^%!' "$<") > "$@"

clean:
	rm -f $(OCT) *.o

distclean: clean
	rm Makefile

.PHONY: all clean
